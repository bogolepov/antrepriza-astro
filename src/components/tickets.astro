---
import "@styles/font.css"
import "@styles/init.css"
import "@styles/antrepriza.css"
import "@styles/tickets.css"

const {lang} = Astro.props;

import programm from '@data/afisha.json'
import dictionary from '@data/dictionary.json'

import plays_ru from '@data/plays_ru.json'
import plays_de from '@data/plays_de.json'

let plays = (lang === 'de') ? plays_de : plays_ru; 

import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';

const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/*.{jpeg,jpg,png,gif}');

programm.sort((play1, play2) => Date.parse(play1.date+"T"+play1.time) - Date.parse(play2.date+"T"+play2.time));

let actualProgramm = programm.filter(performance => Date.parse(performance.date) >= Date.now());

let playsWithGrouppedDatesMap = new Map();
actualProgramm.forEach(element => {
	if (!playsWithGrouppedDatesMap.has(element.play_id)) {
		playsWithGrouppedDatesMap.set(element.play_id, actualProgramm.filter(performance => performance.play_id === element.play_id));
	}
});
let playsWithGrouppedDatesArray = Array.from(playsWithGrouppedDatesMap, ([key, value]) => ({ key, value }));

---

<!-- 
<picture>
	<source srcset={AntreprizaLogo + "#logo-" + lang} type="image/svg+xml" media="(max-width: 570px)">
	<source srcset={AntreprizaLogo + "#logo-text-" + lang} type="image/svg+xml">
	<source srcset="logo_1x.png 1x, logo_2x.png 2x" media="(max-width: 570px)"> 
	<img class="picture-test" src="/src/assets/logo_text_1x_ru.png" srcset="/src/assets/logo_text_2x_ru.png 2x" alt="">
</picture>
-->

<section class="section-tickets">
	{
		playsWithGrouppedDatesArray.map(item => {
			// console.log("key: " + item.key);
			let playInfo;
			plays.some((piece) => {
				if (item.key === piece.id) {
					playInfo = piece;
					return; 
				}
			} )

			if (playInfo) {
				return (
					<div id={playInfo.id_suffix} class="tickets-play-block" data-play={playInfo.id}>
						<div class="tickets-play-text">
							<div class="tickets-play-name">
								{item.value[0].premiere && 
									<span class="tickets-premiere">{dictionary.premiere[lang]}</span>
								}
								<a class="tickets-play-title tickets-play-link" href={"play-"+playInfo.id_suffix+".html"}>
									{playInfo.title}
								</a>
							</div>
							<div class="tickets-play-info">
								<span class="tickets-play-genre" data-label={dictionary.genre[lang]+": "}>{playInfo.genre}, {playInfo.age}</span>
							</div>
							<div class="tickets-play-dates">
								<span class="tickets-play-dates-label">{dictionary.nextDates[lang]}:</span>
								<div class="tickets-book-buttons">
									{
										item.value.map((play_date) => {
												let playDate: Date = new Date(play_date.date);
												return (
													<button class="tickets-book-btn" type="button" data-date={playDate.toDateString()} data-play={playInfo.id}>
														{playDate.getDate().toString().padStart(2, '0')}.{(playDate.getMonth()+1).toString().padStart(2, '0')},
														{playDate.toLocaleDateString(lang, { weekday: 'short' })} / {play_date.time}
													</button>
												)
										} )
									}
								</div>
							</div>
						</div>
						<div class="tickets-play-image">
							<Picture 
								class:list={'play-image'} 
								src={images["/src/assets/" + playInfo.posters.landscape]()} 
								formats={['avif', 'webp']} 
								widths={[280, 400, 640]}
								sizes={'(max-width: 320px) 280px, (max-width: 660px) 640px, (max-width: 1300px) 400px, 640px'}
								alt={playInfo.title} />
						</div>
					</div>
				);
			}
		})
}
</section>


<script>
	const PLAYS = new Array(100).fill(0);

	let ticketBtns = document.getElementsByClassName('tickets-book-btn');
	for (let btn of ticketBtns) {
		if (Date.parse(btn.getAttribute("data-date")) < Date.now()) {
			//(btn as HTMLElement).hidden = true;
			(btn as HTMLElement).disabled = true;
		}
		else {
			PLAYS[btn.getAttribute("data-play")]++;
			btn.addEventListener('click', (event) => {
				// 
			})
		}
	}

	let playBolcks = document.getElementsByClassName('tickets-play-block');
	for (let block of playBolcks) {
		if (!PLAYS[block.getAttribute("data-play")])
			(block as HTMLElement).hidden = true;
	}

</script>
